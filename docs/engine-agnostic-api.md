# Engine-Agnostic API Reference

The VRSecretary backend exposes a **simple HTTP API** that any engine or client can use,
not just Unreal. This document describes the public endpoints, request/response shapes,
and guidelines.

Base URL examples:

- Local: `http://localhost:8000`
- Docker compose: `http://localhost:8000`
- Production: `https://your-domain.com/vrsecretary` (behind a proxy)

---

## 1. Health Check

**Endpoint:**

```http
GET /health
```

**Purpose:**

- Verify the service is running.
- See the configured mode (e.g. `offline_local_ollama`, `online_watsonx`).

**Example Response:**

```json
{
  "status": "ok",
  "mode": "offline_local_ollama",
  "timestamp": "2024-01-15T10:30:00Z"
}
```

**Notes:**

- Safe to call from load balancers or monitoring systems.
- Does not hit the LLM or TTS, so it is very fast.

---

## 2. VR Chat Endpoint

**Endpoint:**

```http
POST /api/vr_chat
```

**Description:**

- Main endpoint for initiating a conversational turn with the VR secretary.
- Takes a user’s text message and returns assistant text + synthesized speech.

### 2.1 Request Schema

Content-Type: `application/json`

```json
{
  "session_id": "string, required",
  "user_text": "string, required"
}
```

- `session_id`
  - A unique identifier for the conversation session.
  - Use a UUID or any stable ID per user/instance.
  - The backend may use this to store and retrieve conversation history.

- `user_text`
  - The message from the user to Ailey (plain text).
  - Should be reasonably bounded in length (backend enforces a max length).

**Example:**

```bash
curl -X POST http://localhost:8000/api/vr_chat           -H "Content-Type: application/json"           -d '{
    "session_id": "demo-user-123",
    "user_text": "Hello Ailey, can you help me plan my week?"
  }'
```

### 2.2 Response Schema

Successful response – HTTP 200:

```json
{
  "assistant_text": "string",
  "audio_wav_base64": "base64-encoded WAV bytes"
}
```

- `assistant_text`
  - The conversational reply generated by the LLM.
  - Usually concise and spoken-friendly (as per Ailey’s prompt).

- `audio_wav_base64`
  - A base64-encoded WAV file.
  - In Unreal, decode this into a `USoundWave` (using a runtime audio importer or custom logic) and play via `UAudioComponent`.

**Example Output (truncated):**

```json
{
  "assistant_text": "Sure, let’s map out your priorities for the week. What are your top three tasks?",
  "audio_wav_base64": "UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YcQAAACAgIC..."
}
```

### 2.3 Error Responses

- **Validation Errors** – HTTP 422

  ```json
  {
    "detail": [
      {
        "loc": ["body", "session_id"],
        "msg": "Field required",
        "type": "value_error.missing"
      }
    ]
  }
  ```

- **Internal Errors** – HTTP 500

  ```json
  {
    "detail": "Error processing request: <error_message>"
  }
  ```

Clients should:

- Treat non-200 codes as failure.
- Show a user-friendly error in the UI (and optionally log technical details).

---

## 3. Authentication

The reference implementation **does not enforce authentication** by default,
to keep development simple.

For production deployments consider:

- API keys via `Authorization: Bearer <token>`.
- JWT tokens (e.g. from an auth provider) verified by the backend.
- IP-based or VPN-based restrictions for internal usage.

Hooks for auth can be added via FastAPI dependencies on the `vr_chat` endpoint.

---

## 4. Rate Limiting & Fair Usage

The reference backend has no built-in rate limiting. For real-world usage:

- Place it behind a reverse proxy (nginx, Traefik, API gateway).
- Use rate-limiting middleware or your proxy’s rate limiting features.
- Limit per IP, per API key, or per session as appropriate.

---

## 5. Extending the API

You can safely extend the HTTP API without breaking the Unreal client:

- Add new endpoints (e.g., `/api/system_prompt`, `/api/session_reset`, `/api/tts_only`).
- Implement structured tool calls (e.g., for scheduling with a calendar).

Keep `/api/vr_chat` stable and backward compatible to avoid breaking existing clients.

---

## 6. Engine-Agnostic Usage Example (Pseudo-Code)

```pseudo
function chatWithAiley(sessionId, userText):
    payload = {
        "session_id": sessionId,
        "user_text": userText
    }

    response = http.post("https://your-backend/api/vr_chat", json=payload)

    if response.status_code != 200:
        raise Error("Backend error: " + response.text)

    data = response.json()
    assistantText = data["assistant_text"]
    audioBase64   = data["audio_wav_base64"]

    return assistantText, audioBase64
```

Any client (web, desktop, mobile, XR) can follow this pattern as long as it can perform HTTP requests and decode base64-encoded WAV audio.
