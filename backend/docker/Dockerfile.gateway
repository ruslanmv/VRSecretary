# backend/gateway/Dockerfile
# Container for the VRSecretary FastAPI gateway (LLM + TTS orchestrator)

FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# System deps (for HTTP clients / SSL etc.); keep it small
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
 && rm -rf /var/lib/apt/lists/*

# Copy project metadata first (for layer caching)
COPY pyproject.toml README.md ./

# Install vrsecretary-gateway and runtime deps
RUN pip install --no-cache-dir .

# Copy the actual application package
COPY vrsecretary_gateway ./vrsecretary_gateway

# Default environment (can be overridden by docker-compose or docker run -e)
# - MODE: offline_local_ollama (Ollama inside compose) or online_watsonx
ENV MODE=offline_local_ollama \
    DEBUG=false \
    OLLAMA_BASE_URL=http://ollama:11434 \
    OLLAMA_MODEL=llama3 \
    OLLAMA_TIMEOUT=60.0 \
    CHATTERBOX_URL=http://host.docker.internal:4123 \
    CHATTERBOX_TIMEOUT=30.0 \
    SESSION_MAX_HISTORY=10

EXPOSE 8000

# Run FastAPI via uvicorn
CMD ["uvicorn", "vrsecretary_gateway.main:app", "--host", "0.0.0.0", "--port", "8000"]
